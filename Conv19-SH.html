<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        #total-amount{
        display: inline-block;
        margin: 15px;
    }
        #total-amount-num,
        #date {
            display: inline-block;
        }

        ul {
            padding: 0;
            display: inline;
        }

        ul li,
        ul li p {
            display: inline-block;
        }
    </style>
    <script src="./canvasjs.min.js"> </script>
    <script src="./jquery-3.1.0.min.js"></script>
    <script>
        window.onload = function () {
            var date = new Date();
            var currentDate = date.toISOString().slice(0,10);
            var aa = document.getElementById('date');
            aa.innerHTML = currentDate;

            var chartData = [];
            var columnDataPoints = [];
            var lineDataPoints = [];
            var regionTrend = {
                type: "line",
                name: "",
                dataPoints: []
            }
            var overallAmount = {
                type: "column",
                name: "当日总数",
                dataPoints: columnDataPoints
            }

            var testData = [{
                type: "line",

                dataPoints: [
                    { x: new Date(2012, 00, 1), y: 450 },
                    { x: new Date(2012, 01, 1), y: 414 },
                    { x: new Date(2012, 02, 1), y: 520 },
                    { x: new Date(2012, 03, 1), y: 460 },
                    { x: new Date(2012, 04, 1), y: 450 },
                    { x: new Date(2012, 05, 1), y: 500 },
                    { x: new Date(2012, 06, 1), y: 480 },
                    { x: new Date(2012, 07, 1), y: 480 },
                    { x: new Date(2012, 08, 1), y: 410 },
                    { x: new Date(2012, 09, 1), y: 500 },
                    { x: new Date(2012, 10, 1), y: 480 },
                    { x: new Date(2012, 11, 1), y: 510 }
                ]
            }
            ]

            var generateChartOption = function (name) {
                return {
                    type: "line",
                    visible: true,
                    name: name,
                    showInLegend: true,
                    legendText: name,
                    axisYType: "secondary",
                    dataPoints: []
                }
            }

            $.getJSON("http://localhost/Covid19-2022-sh/data.json?v=" + Math.random, function (data) {
                var amount = 0;
                $.each(data.Amounts, function (key, value) {
                    columnDataPoints.push({ y: value.Amount, label: value.Day, indexLabel: value.Amount.toString() });
                    amount += value.Amount;
                });
                $.each(data.Details, (key, value) => {
                    var address = value.Address;
                    value.Address.forEach(rgnAddr => {
                        var regionData = lineDataPoints.find(lp => lp.name == rgnAddr.Region);
                        if (!regionData) {
                            regionData = generateChartOption(rgnAddr.Region);
                            lineDataPoints.push(regionData);
                        }
                        regionData.dataPoints.push({ label: value.Day, y: rgnAddr.Addresses.length });
                    });
                })
                chartData.push(overallAmount);
                chartData = chartData.concat(lineDataPoints);

                var lineColor = '';
                var chart = new CanvasJS.Chart("chartContainer", {
                    animationEnabled: true,
                    theme: "light2", // "light1", "light2", "dark1", "dark2"
                    title: {
                        text: "COVID-19 Shanghai 2022"
                    },
                    axisY: {
                        title: "",
                        interlacedColor: "Azure",
                        interval: 100,
                        tickColor: "navy",
                        gridColor: "navy",
                        tickLength: 10
                    },
                    axisY2: {
                        title: "",
                        tickLength: 10
                    },
                    toolTip: {
                        shared: true,
                        contentFormatter: function (e) {
                            var content = " ";
                            for (var i = 0; i < e.entries.length; i++) {
                                content += e.entries[i].dataSeries.name + " " + "<strong>" + e.entries[i].dataPoint.y + "</strong>";
                                content += "<br/>";
                            }
                            return content;
                        }
                    },
                    legend: {
                        cursor: "pointer",
                        itemmouseover: function (e) {
                            e.dataSeries.lineThickness = 15;
                            lineColor = e.dataSeries.lineColor;
                            e.dataSeries.lineColor = "white";
                            chart.render();
                        },
                        itemmouseout: function (e) {
                            e.dataSeries.lineThickness = 2;
                            e.dataSeries.lineColor = lineColor;
                            chart.render();
                        }
                    },
                    data: chartData
                });
                chart.render();

                $("#total-amount").append("<div id=\"total-amount-num\">" + amount + "</div>");

                var allCheckbox = $(".reg-chxbox");
                allCheckbox.each(function( index,$element ) {
                    $(this).on("click", function(e){
                        var name = $element.name;
                        console.log(name);
                        if (index == 0) {
                            udpateAll();
                        } else{
                            if (allCheckbox[0].checked){
                                allCheckbox[0].checked = false;
                                chartData.forEach((cd,j) => j> 0 && (cd.visible = false));
                            }
                            updateRag(index, $element, $element.checked);
                        }
                        function udpateAll(){
                            allCheckbox.each(function(aindex,$all){
                                if (aindex == 0) return;
                                updateRag(aindex, $all, allCheckbox[0].checked);
                                $all.checked = false;
                            });
                        };
                        chart.render();
                    });
                });
            });

            var updateRag = function(index, $element, visible){
                $element.checked = visible;
                chartData[index].visible = visible;
            }
        }
    </script>
</head>

<body>
    总数： <div id="total-amount"></div>
    日期： <div id="date"></div>
    <div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    <div id="region-select"">显示：
    <ul id=" select-container">
        <li>
            <input class="reg-chxbox" type="checkbox" name="all" checked>
            <p>所有</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="徐汇区" >
            <p>徐汇区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="闵行区">
            <p>闵行区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="浦东新区"">
            <p>浦东新区</p>
        </li>
        <li>
            <input class="
                reg-chxbox" type="checkbox" name="黄埔区">
            <p>黄埔区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="静安区"">
            <p>静安区</p>
        </li>
        <li>
            <input class="
                reg-chxbox" type="checkbox" name="长宁区">
            <p>长宁区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="虹口区">
            <p>虹口区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="杨浦区">
            <p>杨浦区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="普陀区">
            <p>普陀区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="宝山区">
            <p>宝山区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="嘉定区">
            <p>嘉定区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="金山区">
            <p>金山区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="松江区">
            <p>松江区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="青浦区">
            <p>青浦区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="奉贤区">
            <p>奉贤区</p>
        </li>
        <li>
            <input class="reg-chxbox" type="checkbox" name="崇明区"">
            <p>崇明区</p>
        </li>
    </ul>
</div>


</body>

</html>