<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hello, World</title>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #container {
            height: 100%
        }
    </style>
    <script type="text/javascript" src="https://api.map.baidu.com/getscript?v=3.0&ak=GRd83ONGj9FEDdQnp49tocaDasu3pz1e"></script>
    <script src="./jquery-3.1.0.min.js"></script>
</head>

<body>
    <div id="container"></div>
</body>

</html>
<script type="text/javascript">

    //当前地理位置的GPS坐标
    var x = 121.506377;
    var y = 31.245105;
    var map = new BMap.Map("container");
    // 百度地图API功能
    var point = new BMap.Point(x, y);
    //地图初始化
    map.centerAndZoom(point, 15);
    map.enableScrollWheelZoom(true);
    map.addControl(new BMap.NavigationControl());

    var myIcon = new BMap.Icon("./source/covid19-22.png", new BMap.Size(23, 25));

    map.addEventListener("dragend", function(){
        // var center =map.getCenter();
        // alert("地图中心点变更为："+ center.lng +", "+ center.lat);
        var bounds = map.getBounds();
        createMarkerInBound(bounds);
    });

    // 显示当前位置
    var labels = ["当前位置"];
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                x = position.coords.longitude;
                y = position.coords.latitude;
                var newPoint = new BMap.Point(x, y);
                //map.panTo(newPoint);
                var convertor = new BMap.Convertor();
                convertor.translate([newPoint], 1, 5, translateNormalCallback);
                map.setCenter(newPoint);
            },
            function (e) {
                console.log("获取当前位置失败");
            }
        )
    }

    setTimeout(() => {
        $.getJSON("http://localhost/Covid19-2022-sh/data.json?v=" + Math.random, function (data) {
                    $.each(data.Details, (key, value) => {
                        var address = value.Address;
                        value.Address.forEach(rgnAddr => {
                            adds = adds.concat(rgnAddr.Addresses);
                            bdGEO(rgnAddr.Addresses);
                        });
                    })
                    // bdGEO(adds);
                    var bounds = map.getBounds();
                    var loopdog = 0;
                    var interval = setInterval(()=>{
                        if (loopdog++ > 50) clearInterval(interval);
                        createMarkerInBound(bounds);
                    }, 100)
                });
    }, 1);
            

    // 批量解析地址
    var myGeo = new BMap.Geocoder();
    var adds = [];
    var addsPoints = [];
    var index = 0;
    function bdGEO(targetAdds) {
        // if (index < adds.length) {
        //     var add = adds[index];
        //     geocodeSearch(add);
        //     index++;
        // }
        for(let i = 0; i< targetAdds.length; i++){
            geocodeSearch(targetAdds[i]);
            index++;
        }
        // 不能一次全部调用，否则页面会卡顿。 getPoint函数比较慢
        // for(let i = 0; i< adds.length; i++){
        //     geocodeSearch(adds[i]);
        // }
    }

    function geocodeSearch(add) {
        if (index < adds.length) {
            setTimeout(window.bdGEO, 1);
        } else {
            console.log("Done");
        }
        myGeo.getPoint(add, function (point) {
            if (point) {
                point.Ye = add;
                addsPoints.push(point);
            }
        }, "上海市");
    }

    function geocodeSearch_sig(add) {
        myGeo.getPoint(add, function (point) {
            if (point) {
                point.Ye = add;
                addsPoints.push(point);
            }
        }, "上海市");
    }

    // 显示当前区域内的标注
    function createMarkerInBound(bounds){
        addsPoints.forEach((aPoint, index) =>{
            if (aPoint['marked']) return;
            if ((aPoint.lng < bounds.Ne && aPoint.lng > bounds.Te) && (aPoint.lat > bounds.ee && aPoint.lat < bounds.ce)){
                var address = new BMap.Point(aPoint.lng, aPoint.lat);
                aPoint['marked'] = true;
                addMarker(address, aPoint.Ye);
            }
        })
    }

    // 编写自定义函数,创建标注
    function addMarker(point, label) {
        var marker = new BMap.Marker(point, { icon: myIcon });
        map.addOverlay(marker);
        var labelObj = new BMap.Label(label, { offset: new BMap.Size(10, -10) });
        labelObj.setStyle({display:"none"});
        marker.setLabel(labelObj);
        marker.addEventListener('mouseover', (...args) => {
            labelObj.setStyle({display:"block"});
        });
        marker.addEventListener('mouseout', (...args) => {
            labelObj.setStyle({display:"none"});
        });
    }

    //坐标转换完之后的回调函数
    function translateCallback (data) {
        if (data.status === 0) {
            for(var i = 0;i<data.points.length; i++){
                addMarker(data.points[i], this.labels[i]);
            }
        }
        else {
            console.error("Convert failed.");
        }
    }

    function translateNormalCallback(data) {
        if(data.status === 0){
            var marker = new BMap.Marker(data.points[0]);
            map.addOverlay(marker);
            var labelObj = new BMap.Label('', { offset: new BMap.Size(10, -10) });
            marker.setLabel(labelObj);
        }
    }

    function coordinateConvertor(points) {
        // var point = new BMap.Point(x, y);
        var convertor = new BMap.Convertor();
        convertor.translate(points, 1, 5, translateCallback);
    };

</script>